<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Check In Kiosk v0.1.0</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    :root {
      --bg-dark: #121212;
      --card-bg: #1e1e1e;
      --input-bg: #2d2d2d;
      --border: #333;
      --text: #e0e0e0;
      --text-secondary: #bbbbbb;
      --text-muted: #999;
      --red-bg: #4a1a1a;
      --red-text: #ff6b6b;
      --blue-select: #339af0;
      --success: #28a745;
      --primary: #0d6efd;
      --primary-hover: #0b5ed7;
      --success-hover: #218838;
      --table-header-bg: #2a2a2a;
      --table-header-text: #e0e0e0;
      --input-border: #444;
      --input-focus-bg: #333;
      --input-focus-border: var(--primary);
      --input-focus-shadow: rgba(13, 110, 253, 0.25);
      --logo-url: none;
      --logo-display: none;
    }

    body { 
      background: var(--bg-dark); 
      color: var(--text); 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0;
    }

    .main-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      padding: 0.75rem 1.5rem 0.5rem;
      margin: 0.5rem;
      display: flex;
      flex-direction: column;
    }

    @media (min-width: 769px) {
      .main-card { margin: 0.5rem; }
    }

    .form-control, .form-select {
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      color: var(--text);
      border-radius: 8px;
    }
    .form-control:focus, .form-select:focus {
      background: var(--input-focus-bg);
      border-color: var(--input-focus-border);
      box-shadow: 0 0 0 0.2rem var(--input-focus-shadow);
      color: var(--text);
    }

    .btn-primary { background: var(--primary); border: none; color: #fff; }
    .btn-primary:disabled { background: #888; opacity: 0.7; cursor: not-allowed; }
    .btn-primary:not(:disabled) { background: var(--success); }
    .btn-primary:not(:disabled):hover { background: var(--success-hover); }
    .btn-success { background: var(--success); border: none; }
    .btn-success:hover { background: var(--success-hover); }

    /* STATUS BAR */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 0.5rem 0 0.25rem 0;
      min-height: 1.5rem;
    }
    .status { 
      font-weight: 600; 
      padding: 0.25rem 0;
      flex: 1;
    }

    /* APPOINTMENT DETAIL FORM */
    #apptForm { display: none; margin-top: 0.25rem; }
    .appt-form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 0.5rem 1rem;
    }
    .appt-form-grid .form-group label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }
    .appt-form-grid .form-control {
      font-size: 0.95rem;
      padding: 0.5rem 0.75rem;
    }
    .appt-form-grid .form-control[readonly] {
      background: var(--input-bg);
      opacity: 0.75;
      cursor: default;
      border-style: dashed;
    }
    .required-asterisk { color: #dc3545; margin-left: 2px; }
    .btn-success:disabled { background: #888; opacity: 0.7; cursor: not-allowed; }

    /* SIGNATURE PAD */
    .signature-section {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border);
    }
    .signature-section label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .signature-pad-wrapper {
      border: 2px dashed var(--border);
      border-radius: 8px;
      background: var(--input-bg);
      position: relative;
      cursor: crosshair;
      touch-action: none;
    }
    .signature-pad-wrapper canvas {
      display: block;
      width: 100%;
      border-radius: 6px;
    }
    /* CHECK IN BUTTON AREA */
    .form-actions {
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border);
    }

    @media (max-width: 1200px) {
      .appt-form-grid {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }
    @media (max-width: 900px) {
      .appt-form-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 768px) {
      .main-card {
        margin: 0;
        border-radius: 0;
      }
      .appt-form-grid {
        grid-template-columns: 1fr;
      }
    }

    .form-label { color: var(--text-secondary); font-weight: 600; }
    small { color: var(--text-muted); }
    h2 { color: var(--primary); }
    
    /* THEME SELECTOR */
    .theme-selector-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      color: var(--text);
      padding: 0;
      cursor: pointer;
      font-size: 1.5rem;
      z-index: 1000;
      transition: opacity 0.2s;
    }
    .theme-selector-btn:hover {
      opacity: 0.7;
    }
    
    /* LOGO */
    .theme-logo {
      display: var(--logo-display);
      max-height: 50px;
      max-width: 200px;
      margin: 0 auto 0.25rem;
      object-fit: contain;
    }
    
    .header-with-logo {
      position: relative;
    }

    /* HIDDEN UNTIL AUTH */
    #mainUI { display: none; }

    /* ORG INPUT SIZE */
    #org {
      width: 250px;
      max-width: 100%;
    }

    /* MODAL */
    .modal-content {
      background-color: var(--card-bg);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .modal-header, .modal-footer {
      border-color: var(--border);
    }
  </style>
</head>
<body>
  <div class="main-card">
    <button class="theme-selector-btn" id="themeSelectorBtn" title="Select Theme">
      <i class="fas fa-cog"></i>
    </button>
    <div class="header-with-logo">
      <img id="themeLogo" class="theme-logo" alt="Theme Logo" />
      <h2 class="text-center mb-2" style="font-size:1.3rem;">Check In Kiosk v0.1.0</h2>
    </div>

    <!-- ORG -->
    <div class="mb-3" id="orgSection">
      <label class="form-label">ORG:</label>
      <input type="text" id="org" class="form-control" placeholder="Enter ORG" maxlength="20" />
      <small>Press Enter to authenticate</small>
    </div>

    <!-- MAIN UI (Hidden until auth) -->
    <div id="mainUI">
      <!-- APPOINTMENT ID INPUT -->
      <div class="mb-3">
        <label class="form-label">Enter Appointment:</label>
        <input type="text" id="criteria" class="form-control" placeholder="Enter Appointment ID" />
      </div>

      <!-- STATUS + FIND BUTTON -->
      <div class="status-bar">
        <div class="status" id="status">Enter ORG and press Enter to authenticate</div>
        <button id="findBtn" class="btn btn-primary px-4" disabled>Find Appointment</button>
      </div>

      <!-- APPOINTMENT DETAIL FORM -->
      <div id="apptForm">
        <div class="appt-form-grid">
          <div class="form-group">
            <label>Appointment</label>
            <input type="text" id="fld_appointmentId" class="form-control" readonly />
          </div>
          <div class="form-group">
            <label>Appointment Type</label>
            <input type="text" id="fld_appointmentType" class="form-control" readonly />
          </div>
          <div class="form-group">
            <label>Scheduled Date</label>
            <input type="text" id="fld_scheduledDate" class="form-control" readonly />
          </div>
          <div class="form-group">
            <label>Check In Time</label>
            <input type="text" id="fld_checkInTime" class="form-control" readonly />
          </div>
          <div class="form-group">
            <label>Carrier<span class="required-asterisk">*</span></label>
            <input type="text" id="fld_carrier" class="form-control" />
          </div>
          <div class="form-group">
            <label>Trailer<span class="required-asterisk">*</span></label>
            <input type="text" id="fld_trailer" class="form-control" />
          </div>
          <div class="form-group">
            <label>Truck Number</label>
            <input type="text" id="fld_truckNumber" class="form-control" />
          </div>
          <div class="form-group">
            <label>Driver Name</label>
            <input type="text" id="fld_driverName" class="form-control" />
          </div>
          <div class="form-group">
            <label>Driver Phone Number</label>
            <input type="text" id="fld_driverPhone" class="form-control" />
          </div>
          <div class="form-group">
            <label>Driver's License Number</label>
            <input type="text" id="fld_driverLicense" class="form-control" />
          </div>
          <div class="form-group">
            <label>Tractor License Plate</label>
            <input type="text" id="fld_tractorPlate" class="form-control" />
          </div>
          <div class="form-group">
            <label>Trailer Contents</label>
            <input type="text" id="fld_trailerContents" class="form-control" readonly />
          </div>
        </div>

        <!-- Signature Pad -->
        <div class="signature-section">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.35rem;">
            <label style="margin:0;">Driver's Signature</label>
            <button type="button" class="btn btn-sm btn-secondary" id="clearSignature">Clear Signature</button>
          </div>
          <div class="signature-pad-wrapper">
            <canvas id="signaturePad"></canvas>
          </div>
        </div>

        <!-- Check In Button -->
        <div class="form-actions">
          <button id="checkinBtn" class="btn btn-success btn-lg w-100" disabled>Check In</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SUCCESS MODAL -->
  <div class="modal fade" id="checkinModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-success">Check In Complete</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="checkinMessage"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- THEME SELECTOR MODAL -->
  <div class="modal fade" id="themeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Select Theme</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="list-group" id="themeList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const orgInput = document.getElementById('org');
    const mainUI = document.getElementById('mainUI');
    const criteriaInput = document.getElementById('criteria');
    const findBtn = document.getElementById('findBtn');
    const apptForm = document.getElementById('apptForm');
    const statusEl = document.getElementById('status');
    const checkinBtn = document.getElementById('checkinBtn');
    const checkinModal = new bootstrap.Modal(document.getElementById('checkinModal'));
    const checkinMessage = document.getElementById('checkinMessage');
    const themeSelectorBtn = document.getElementById('themeSelectorBtn');
    const themeModal = new bootstrap.Modal(document.getElementById('themeModal'));
    const themeList = document.getElementById('themeList');
    const themeLogo = document.getElementById('themeLogo');

    // Form field references
    const fld = {
      appointmentId: document.getElementById('fld_appointmentId'),
      appointmentType: document.getElementById('fld_appointmentType'),
      scheduledDate: document.getElementById('fld_scheduledDate'),
      checkInTime: document.getElementById('fld_checkInTime'),
      carrier: document.getElementById('fld_carrier'),
      trailer: document.getElementById('fld_trailer'),
      truckNumber: document.getElementById('fld_truckNumber'),
      driverName: document.getElementById('fld_driverName'),
      driverPhone: document.getElementById('fld_driverPhone'),
      driverLicense: document.getElementById('fld_driverLicense'),
      tractorPlate: document.getElementById('fld_tractorPlate'),
      trailerContents: document.getElementById('fld_trailerContents')
    };

    let token = null;
    let currentAppt = null; // Full appointment data from API
    let validAppointmentIds = new Set(); // Cached from /api/scheduled after auth
    let hasSigned = false; // Track whether signature pad has been drawn on

    // THEME DEFINITIONS
    const themes = {
      'default': {
        name: 'Default (Dark)',
        colors: {
          '--bg-dark': '#121212',
          '--card-bg': '#1e1e1e',
          '--input-bg': '#2d2d2d',
          '--border': '#333',
          '--text': '#e0e0e0',
          '--text-secondary': '#bbbbbb',
          '--text-muted': '#999',
          '--red-bg': '#4a1a1a',
          '--red-text': '#ff6b6b',
          '--blue-select': '#339af0',
          '--success': '#28a745',
          '--primary': '#0d6efd',
          '--primary-hover': '#0b5ed7',
          '--success-hover': '#218838',
          '--table-header-bg': '#2a2a2a',
          '--table-header-text': '#e0e0e0',
          '--input-border': '#444',
          '--input-focus-bg': '#333',
          '--input-focus-border': '#0d6efd',
          '--input-focus-shadow': 'rgba(13, 110, 253, 0.25)',
          '--logo-url': 'none',
          '--logo-display': 'none'
        },
        logo: null
      },
      'loves': {
        name: "Love's Travel Stops",
        colors: {
          '--bg-dark': '#f8f9fa',
          '--card-bg': '#ffffff',
          '--input-bg': '#f5f5f5',
          '--border': '#dee2e6',
          '--text': '#212529',
          '--text-secondary': '#495057',
          '--text-muted': '#6c757d',
          '--red-bg': '#fff5f5',
          '--red-text': '#dc3545',
          '--blue-select': '#0056b3',
          '--success': '#28a745',
          '--primary': '#E31837',
          '--primary-hover': '#C0142D',
          '--success-hover': '#218838',
          '--table-header-bg': '#E31837',
          '--table-header-text': '#ffffff',
          '--input-border': '#ced4da',
          '--input-focus-bg': '#ffffff',
          '--input-focus-border': '#E31837',
          '--input-focus-shadow': 'rgba(227, 24, 55, 0.25)',
          '--logo-url': 'url("/loves-logo.png")',
          '--logo-display': 'block'
        },
        logo: '/loves-logo.png'
      },
      'manhattan': {
        name: 'Manhattan Associates',
        colors: {
          '--bg-dark': '#f5f7fa',
          '--card-bg': '#ffffff',
          '--input-bg': '#f0f2f5',
          '--border': '#e1e8ed',
          '--text': '#1a1a1a',
          '--text-secondary': '#4a5568',
          '--text-muted': '#718096',
          '--red-bg': '#fff5f5',
          '--red-text': '#e53e3e',
          '--blue-select': '#3182ce',
          '--success': '#38a169',
          '--primary': '#0066cc',
          '--primary-hover': '#0052a3',
          '--success-hover': '#2f855a',
          '--table-header-bg': '#0066cc',
          '--table-header-text': '#ffffff',
          '--input-border': '#cbd5e0',
          '--input-focus-bg': '#ffffff',
          '--input-focus-border': '#0066cc',
          '--input-focus-shadow': 'rgba(0, 102, 204, 0.25)',
          '--logo-url': 'url("/manhattan-logo.png")',
          '--logo-display': 'block'
        },
        logo: '/manhattan-logo.png'
      },
      'msc': {
        name: 'MSC Industrial Supply',
        colors: {
          '--bg-dark': '#fafafa',
          '--card-bg': '#ffffff',
          '--input-bg': '#f0f0f0',
          '--border': '#e0e0e0',
          '--text': '#1a1a1a',
          '--text-secondary': '#4a4a4a',
          '--text-muted': '#757575',
          '--red-bg': '#ffebee',
          '--red-text': '#c62828',
          '--blue-select': '#1976d2',
          '--success': '#388e3c',
          '--primary': '#003d82',
          '--primary-hover': '#002d5f',
          '--success-hover': '#2e7d32',
          '--table-header-bg': '#003d82',
          '--table-header-text': '#ffffff',
          '--input-border': '#bdbdbd',
          '--input-focus-bg': '#ffffff',
          '--input-focus-border': '#003d82',
          '--input-focus-shadow': 'rgba(0, 61, 130, 0.25)',
          '--logo-url': 'url("/msc-logo.png")',
          '--logo-display': 'block'
        },
        logo: '/msc-logo.png'
      },
      'light': {
        name: 'Light Theme',
        colors: {
          '--bg-dark': '#f8f9fa',
          '--card-bg': '#ffffff',
          '--input-bg': '#f5f5f5',
          '--border': '#dee2e6',
          '--text': '#212529',
          '--text-secondary': '#495057',
          '--text-muted': '#6c757d',
          '--red-bg': '#fff5f5',
          '--red-text': '#dc3545',
          '--blue-select': '#0056b3',
          '--success': '#28a745',
          '--primary': '#0d6efd',
          '--primary-hover': '#0b5ed7',
          '--success-hover': '#218838',
          '--table-header-bg': '#6c757d',
          '--table-header-text': '#ffffff',
          '--input-border': '#ced4da',
          '--input-focus-bg': '#ffffff',
          '--input-focus-border': '#0d6efd',
          '--input-focus-shadow': 'rgba(13, 110, 253, 0.25)',
          '--logo-url': 'none',
          '--logo-display': 'none'
        },
        logo: null
      },
      'rockline': {
        name: 'Rockline Industries',
        colors: {
          '--bg-dark': '#f4f6f3',
          '--card-bg': '#ffffff',
          '--input-bg': '#f0f2ee',
          '--border': '#d4ddd0',
          '--text': '#2d2d2d',
          '--text-secondary': '#4a5548',
          '--text-muted': '#6b7d66',
          '--red-bg': '#fff5f5',
          '--red-text': '#c62828',
          '--blue-select': '#4a8c3f',
          '--success': '#6EB43F',
          '--primary': '#6EB43F',
          '--primary-hover': '#5a9a32',
          '--success-hover': '#5a9a32',
          '--table-header-bg': '#2d2d2d',
          '--table-header-text': '#ffffff',
          '--input-border': '#b8c9b3',
          '--input-focus-bg': '#ffffff',
          '--input-focus-border': '#6EB43F',
          '--input-focus-shadow': 'rgba(110, 180, 63, 0.25)',
          '--logo-url': 'url("/rockline_logo.png")',
          '--logo-display': 'block'
        },
        logo: '/rockline_logo.png'
      },
      'corporate-blue': {
        name: 'Corporate Blue',
        colors: {
          '--bg-dark': '#e3f2fd',
          '--card-bg': '#ffffff',
          '--input-bg': '#f5f5f5',
          '--border': '#90caf9',
          '--text': '#1565c0',
          '--text-secondary': '#1976d2',
          '--text-muted': '#64b5f6',
          '--red-bg': '#ffebee',
          '--red-text': '#c62828',
          '--blue-select': '#0d47a1',
          '--success': '#2e7d32',
          '--primary': '#1565c0',
          '--primary-hover': '#0d47a1',
          '--success-hover': '#1b5e20',
          '--table-header-bg': '#1565c0',
          '--table-header-text': '#ffffff',
          '--input-border': '#90caf9',
          '--input-focus-bg': '#ffffff',
          '--input-focus-border': '#1565c0',
          '--input-focus-shadow': 'rgba(21, 101, 192, 0.25)',
          '--logo-url': 'none',
          '--logo-display': 'none'
        },
        logo: null
      }
    };

    // THEME FUNCTIONS
    function applyTheme(themeKey) {
      const theme = themes[themeKey];
      if (!theme) return;

      const root = document.documentElement;
      Object.entries(theme.colors).forEach(([property, value]) => {
        root.style.setProperty(property, value);
      });

      // Update logo
      if (theme.logo) {
        themeLogo.src = theme.logo;
        themeLogo.style.display = 'block';
      } else {
        themeLogo.style.display = 'none';
      }

      // Save to localStorage
      localStorage.setItem('selectedTheme', themeKey);
    }

    function loadTheme() {
      const savedTheme = localStorage.getItem('selectedTheme') || 'default';
      applyTheme(savedTheme);
    }

    function renderThemeList() {
      themeList.innerHTML = '';
      const currentTheme = localStorage.getItem('selectedTheme') || 'default';
      
      Object.entries(themes).forEach(([key, theme]) => {
        const item = document.createElement('button');
        item.type = 'button';
        item.className = `list-group-item list-group-item-action ${key === currentTheme ? 'active' : ''}`;
        item.textContent = theme.name;
        item.onclick = () => {
          applyTheme(key);
          themeModal.hide();
        };
        themeList.appendChild(item);
      });
    }

    // Theme selector button
    themeSelectorBtn.onclick = () => {
      renderThemeList();
      themeModal.show();
    };

    // Load theme on page load
    window.addEventListener('load', async () => {
      // Check URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      
      // Hide theme gear icon if theme=N
      const themeParam = urlParams.get('theme');
      if (themeParam && themeParam.toUpperCase() === 'N') {
        themeSelectorBtn.style.display = 'none';
      }
      
      loadTheme();
      
      // Track app opened with full metadata
      trackEvent('app_opened', {});
      
      api('app_opened', {});
      
      // Auto-authenticate if org or organization URL parameter is present
      const autoOrg = urlParams.get('org') || urlParams.get('organization');
      if (autoOrg) {
        orgInput.value = autoOrg;
        await authenticate(autoOrg.trim());
      } else {
        orgInput.focus();
      }
    });

    // STATUS
    function status(text, type = 'info') {
      statusEl.textContent = text;
      statusEl.className = `status text-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'}`;
    }

    // API
    async function api(action, data = {}) {
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers.Authorization = `Bearer ${token}`;
      return fetch(`/api/${action}`, {
        method: 'POST',
        headers,
        body: JSON.stringify(data)
      }).then(r => r.json());
    }

    // ===== SESSION TRACKING =====
    const SESSION_STORAGE_KEY = 'appt_app_session';
    let sessionId = null;
    let pageLoadTime = null;
    let authAttemptCount = 0;
    let firstAuthSuccess = true;

    // Initialize session on page load
    (function initSession() {
      pageLoadTime = Date.now();
      
      // Get or create session ID
      sessionId = sessionStorage.getItem(SESSION_STORAGE_KEY);
      if (!sessionId) {
        sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
        sessionStorage.setItem(SESSION_STORAGE_KEY, sessionId);
      }
      
      // Check if returning user
      const hasSavedPreferences = localStorage.getItem('selectedTheme') !== null;
      
      // Store for metadata collection
      window._appSession = {
        sessionId,
        pageLoadTime,
        hasSavedPreferences
      };
    })();

    // ===== GENERIC METADATA COLLECTION (Reusable across all apps) =====
    function getCommonMetadata(additionalMetadata = {}) {
      const now = Date.now();
      const timeOnPage = pageLoadTime ? Math.floor((now - pageLoadTime) / 1000) : 0;
      
      // Parse user agent
      const ua = navigator.userAgent;
      const browserInfo = parseUserAgent(ua);
      
      // Get screen info
      const screenWidth = window.screen.width;
      const screenHeight = window.screen.height;
      const screenResolution = `${screenWidth}x${screenHeight}`;
      
      // Get URL parameters
      const urlParamsObj = {};
      const currentUrlParams = new URLSearchParams(window.location.search);
      for (const [key, value] of currentUrlParams.entries()) {
        urlParamsObj[key] = value;
      }
      
      // Get theme
      const currentTheme = localStorage.getItem('selectedTheme') || 'default';
      
      // Build common metadata
      const commonMetadata = {
        // Category 1: User/Browser Information
        user_agent: ua,
        browser_name: browserInfo.name,
        browser_version: browserInfo.version,
        device_type: getDeviceType(),
        os_name: browserInfo.os,
        os_version: browserInfo.osVersion,
        screen_resolution: screenResolution,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        language: navigator.language || navigator.userLanguage,
        
        // Category 2: Session & Context
        session_id: sessionId,
        page_load_time: pageLoadTime ? new Date(pageLoadTime).toISOString() : null,
        time_on_page: timeOnPage,
        referrer: document.referrer || null,
        url_params: Object.keys(urlParamsObj).length > 0 ? urlParamsObj : null,
        auto_authenticated: false, // This app doesn't use URL params for auto-auth
        
        // Category 3: App State & Preferences
        theme: currentTheme,
        has_saved_preferences: window._appSession?.hasSavedPreferences || false,
        
        // Category 4: Authentication Context (will be overridden by event-specific data)
        auth_method: 'manual',
        auth_attempt_count: authAttemptCount,
        first_auth_success: firstAuthSuccess,
        
        // Category 7: Error & Debugging (will be populated if error occurs)
        // error_code, error_message, stack_trace, api_error_details - added per event
        
        // Category 8: Cross-App Integration
        source_app: null,
        integration_type: 'direct',
        
        // Category 10: Geographic/Network
        request_origin: window.location.origin,
        
        // Merge any additional metadata
        ...additionalMetadata
      };
      
      return commonMetadata;
    }

    // Helper: Parse user agent
    function parseUserAgent(ua) {
      let name = 'Unknown';
      let version = 'Unknown';
      let os = 'Unknown';
      let osVersion = 'Unknown';
      
      // Browser detection
      if (ua.includes('Chrome') && !ua.includes('Edg')) {
        name = 'Chrome';
        const match = ua.match(/Chrome\/([\d.]+)/);
        version = match ? match[1] : 'Unknown';
      } else if (ua.includes('Firefox')) {
        name = 'Firefox';
        const match = ua.match(/Firefox\/([\d.]+)/);
        version = match ? match[1] : 'Unknown';
      } else if (ua.includes('Safari') && !ua.includes('Chrome')) {
        name = 'Safari';
        const match = ua.match(/Version\/([\d.]+)/);
        version = match ? match[1] : 'Unknown';
      } else if (ua.includes('Edg')) {
        name = 'Edge';
        const match = ua.match(/Edg\/([\d.]+)/);
        version = match ? match[1] : 'Unknown';
      }
      
      // OS detection
      if (ua.includes('Windows')) {
        os = 'Windows';
        const match = ua.match(/Windows NT ([\d.]+)/);
        if (match) {
          const ntVersion = match[1];
          const versionMap = {
            '10.0': '10/11',
            '6.3': '8.1',
            '6.2': '8',
            '6.1': '7'
          };
          osVersion = versionMap[ntVersion] || ntVersion;
        }
      } else if (ua.includes('Mac OS X') || ua.includes('Macintosh')) {
        os = 'macOS';
        const match = ua.match(/Mac OS X ([\d_]+)/);
        if (match) {
          osVersion = match[1].replace(/_/g, '.');
        }
      } else if (ua.includes('Linux')) {
        os = 'Linux';
      } else if (ua.includes('Android')) {
        os = 'Android';
        const match = ua.match(/Android ([\d.]+)/);
        osVersion = match ? match[1] : 'Unknown';
      } else if (ua.includes('iPhone') || ua.includes('iPad')) {
        os = 'iOS';
        const match = ua.match(/OS ([\d_]+)/);
        if (match) {
          osVersion = match[1].replace(/_/g, '.');
        }
      }
      
      return { name, version, os, osVersion };
    }

    // Helper: Get device type
    function getDeviceType() {
      const ua = navigator.userAgent;
      if (/tablet|ipad|playbook|silk/i.test(ua)) {
        return 'tablet';
      }
      if (/mobile|iphone|ipod|android|blackberry|opera|mini|windows\sce|palm|smartphone|iemobile/i.test(ua)) {
        return 'mobile';
      }
      return 'desktop';
    }

    // Home Assistant tracking helper with enhanced metadata
    async function trackEvent(eventName, metadata = {}) {
      try {
        // Get common metadata and merge with event-specific metadata
        const fullMetadata = getCommonMetadata(metadata);
        
        await api('ha-track', {
          event_name: eventName,
          metadata: fullMetadata
        });
      } catch (error) {
        // Silently fail - don't interrupt user experience
        console.warn('[HA] Failed to track event:', error);
      }
    }

    // Auth function (reusable for manual and auto-auth)
    async function authenticate(org) {
      if (!org) return status('ORG required', 'error');
      
      // Increment auth attempt count
      authAttemptCount++;
      const authStartTime = Date.now();
      
      // Track auth attempt
      trackEvent('auth_attempt', {
        org: org || 'unknown',
        auth_attempt_count: authAttemptCount
      });
      
      status('Authenticating...');
      const res = await api('auth', { org });
      const authDuration = Date.now() - authStartTime;
      
      if (!res.success) {
        // Track auth failure
        trackEvent('auth_failed', {
          org: org || 'unknown',
          error: res.error || 'Auth failed',
          error_message: res.error || 'Auth failed',
          auth_attempt_count: authAttemptCount,
          auth_duration_ms: authDuration,
          token_received: false
        });
        firstAuthSuccess = false;
        return status(res.error || 'Auth failed', 'error');
      }
      
      token = res.token;
      status('Authenticated – loading appointments...', 'success');
      
      // Track auth success
      trackEvent('auth_success', {
        org: org,
        auth_attempt_count: authAttemptCount,
        auth_duration_ms: authDuration,
        token_received: true,
        first_auth_success: firstAuthSuccess
      });
      
      // Reset for next session (if they log out and back in)
      firstAuthSuccess = false;
      
      // Hide ORG section after successful auth
      document.getElementById('orgSection').style.display = 'none';
      
      mainUI.style.display = 'block';
      
      // Fetch all scheduled appointments to build valid ID list
      const scheduledRes = await api('scheduled', { org, token });
      if (scheduledRes.success && scheduledRes.appointments) {
        validAppointmentIds = new Set(
          scheduledRes.appointments.map(a => String(a.AppointmentId)).filter(Boolean)
        );
        status(`Ready – ${validAppointmentIds.size} scheduled appointments available`, 'success');
      } else {
        validAppointmentIds = new Set();
        status('Authenticated – could not load appointments', 'error');
      }
      
      setTimeout(() => criteriaInput.focus(), 100);
    }

    // Auth on Enter key
    orgInput.addEventListener('keypress', async e => {
      if (e.key !== 'Enter') return;
      await authenticate(orgInput.value.trim());
    });

    // Real-time validation: enable Find button only when input matches a valid AppointmentId
    criteriaInput.addEventListener('input', () => {
      const value = criteriaInput.value.trim();
      findBtn.disabled = !value || !validAppointmentIds.has(value);
    });

    // Enter → Search (only if button is enabled)
    criteriaInput.addEventListener('keypress', e => {
      if (e.key === 'Enter' && !findBtn.disabled) findBtn.click();
    });

    // Validate Check In when required fields change
    fld.carrier.addEventListener('input', validateCheckIn);
    fld.trailer.addEventListener('input', validateCheckIn);

    // Date formatting helpers
    function formatDateNice(dateStr) {
      if (!dateStr) return '';
      try {
        const dt = new Date(dateStr);
        return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) +
               ' at ' + dt.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
      } catch { return ''; }
    }

    function formatCurrentTime() {
      const now = new Date();
      return now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) +
             ' at ' + now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
    }

    function formatApptType(typeId) {
      if (!typeId) return '';
      return typeId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    // Format trailer contents from AppointmentContents
    function formatTrailerContents(appt) {
      const contents = appt.AppointmentContents;
      if (!contents || !Array.isArray(contents) || contents.length === 0) return '';

      const pos = new Set();
      const asns = new Set();

      contents.forEach(item => {
        // Handle nested object format: { PurchaseOrderId: { PurchaseOrderId: "PO123" } }
        const poObj = item.PurchaseOrderId;
        if (poObj) {
          const poId = typeof poObj === 'string' ? poObj : (poObj.PurchaseOrderId || null);
          if (poId) pos.add(poId);
        }
        // Also check flat format: { BillOfLadingNumber: "...", PurchaseOrderNumber: "..." }
        if (item.PurchaseOrderNumber) pos.add(item.PurchaseOrderNumber);

        const asnObj = item.AsnId;
        if (asnObj) {
          const asnId = typeof asnObj === 'string' ? asnObj : (asnObj.AsnId || null);
          if (asnId) asns.add(asnId);
        }
      });

      const parts = [];
      if (pos.size > 0) {
        const label = pos.size === 1 ? 'PO' : 'POs';
        parts.push(`${label}: ${[...pos].join(', ')}`);
      }
      if (asns.size > 0) {
        const label = asns.size === 1 ? 'ASN' : 'ASNs';
        parts.push(`${label}: ${[...asns].join(', ')}`);
      }
      return parts.join(',   ');
    }

    // Populate the appointment detail form
    function populateForm(appt) {
      currentAppt = appt;
      fld.appointmentId.value = appt.AppointmentId || '';
      fld.appointmentType.value = formatApptType(appt.AppointmentTypeId);
      fld.scheduledDate.value = formatDateNice(appt.PreferredDateTime);
      fld.checkInTime.value = formatCurrentTime();
      fld.carrier.value = appt.CarrierId || '';
      fld.trailer.value = appt.TrailerId || '';
      fld.truckNumber.value = appt.TractorId || '';
      fld.driverName.value = appt.DriverId || '';
      fld.driverPhone.value = '';
      fld.driverLicense.value = '';
      fld.tractorPlate.value = '';
      fld.trailerContents.value = formatTrailerContents(appt);

      hasSigned = false;
      apptForm.style.display = 'block';

      // Initialize signature pad now that form is visible
      requestAnimationFrame(() => {
        resizeSignatureCanvas();
        clearSignaturePad();
      });

      validateCheckIn();
    }

    // Reset form
    function resetForm() {
      Object.values(fld).forEach(input => { input.value = ''; });
      hasSigned = false;
      clearSignaturePad();
      apptForm.style.display = 'none';
      currentAppt = null;
      checkinBtn.disabled = true;
    }

    // Validate required fields: Carrier, Trailer, and Signature
    function validateCheckIn() {
      if (!currentAppt || currentAppt.AppointmentStatusId !== '3000') {
        checkinBtn.disabled = true;
        return;
      }
      const carrierOk = fld.carrier.value.trim().length > 0;
      const trailerOk = fld.trailer.value.trim().length > 0;
      checkinBtn.disabled = !(carrierOk && trailerOk && hasSigned);
    }

    // Find
    findBtn.onclick = async () => {
      const appointmentId = criteriaInput.value.trim();
      if (!appointmentId) return status('Enter an Appointment ID', 'error');
      
      const org = orgInput.value.trim() || 'unknown';
      const searchStartTime = Date.now();
      
      // Track search attempt
      trackEvent('search_attempt', {
        org: org,
        appointment_id: appointmentId
      });
      
      status('Finding appointment...');
      const apiStartTime = Date.now();
      const res = await api('search', { org, appointment_id: appointmentId, token });
      const apiResponseTime = Date.now() - apiStartTime;
      const searchDuration = Date.now() - searchStartTime;
      
      if (!res.success || !res.results || res.results.length === 0) {
        resetForm();
        trackEvent('search_failed', {
          org: org,
          appointment_id: appointmentId,
          error: res.error || 'No results',
          search_duration_ms: searchDuration,
          api_response_time_ms: apiResponseTime
        });
        return status('Appointment not found', 'error');
      }
      
      populateForm(res.results[0]);
      status('Appointment loaded', 'success');
      
      // Track search success
      trackEvent('search_completed', {
        org: org,
        appointment_id: appointmentId,
        results_count: res.results.length,
        search_duration_ms: searchDuration,
        api_response_time_ms: apiResponseTime
      });
    };

    // Check In — merge form values with original API data
    checkinBtn.onclick = async () => {
      if (!currentAppt) return;

      // Build merged appointment from API data + form edits
      const appt = {
        ...currentAppt,
        CarrierId: fld.carrier.value.trim() || currentAppt.CarrierId,
        TrailerId: fld.trailer.value.trim() || currentAppt.TrailerId,
        TractorId: fld.truckNumber.value.trim() || currentAppt.TractorId,
        DriverId: fld.driverName.value.trim() || currentAppt.DriverId
      };

      await performCheckIn(appt);
    };

    // Perform check-in
    async function performCheckIn(appt) {
      const org = orgInput.value.trim() || 'unknown';
      
      // Extract BOL from AppointmentContents
      let bol = null;
      if (appt.AppointmentContents) {
        if (Array.isArray(appt.AppointmentContents) && appt.AppointmentContents.length > 0) {
          bol = appt.AppointmentContents[0].BillOfLadingNumber || null;
        } else if (appt.AppointmentContents.BillOfLadingNumber) {
          bol = appt.AppointmentContents.BillOfLadingNumber;
        }
      }
      
      // Check for missing fields
      const missingFields = [];
      if (!appt.CarrierId) missingFields.push('CarrierId');
      if (!appt.TrailerId) missingFields.push('TrailerId');
      if (!appt.AppointmentTypeId) missingFields.push('AppointmentTypeId');
      if (!appt.EquipmentTypeId) missingFields.push('EquipmentTypeId');
      
      const checkinStartTime = Date.now();
      
      // Track check-in attempt with appointment-specific metadata
      trackEvent('checkin_attempt', {
        org: org,
        appointment_id: appt.AppointmentId || 'unknown',
        carrier_id: appt.CarrierId || null,
        trailer_id: appt.TrailerId || null,
        equipment_type_id: appt.EquipmentTypeId || null,
        appointment_type_id: appt.AppointmentTypeId || null,
        bol: bol,
        has_missing_fields: missingFields.length > 0,
        missing_fields_list: missingFields.length > 0 ? missingFields : null
      });
      
      status('Checking in trailer...');
      checkinBtn.disabled = true;

      const apiStartTime = Date.now();
      const res = await api('checkin', { 
        appt, 
        org, 
        token 
      });
      const apiResponseTime = Date.now() - apiStartTime;
      const checkinDuration = Date.now() - checkinStartTime;

      if (res.success) {
        // Upload signature BEFORE resetting form (need canvas data)
        status('Uploading signature...', 'success');
        await uploadSignaturesForAppointment(appt, org);

        checkinMessage.textContent = `${res.message || 'Check-in successful'}`;
        checkinModal.show();
        
        // Calculate payload size
        const payloadSize = JSON.stringify({ appt, org, token }).length;
        
        // Track check-in success with appointment-specific metadata
        trackEvent('checkin_completed', {
          org: org,
          appointment_id: appt.AppointmentId || 'unknown',
          carrier_id: appt.CarrierId || null,
          trailer_id: appt.TrailerId || null,
          equipment_type_id: appt.EquipmentTypeId || null,
          appointment_type_id: appt.AppointmentTypeId || null,
          bol: bol,
          checkin_message: res.message || 'Check-in successful',
          checkin_duration_ms: checkinDuration,
          api_response_time_ms: apiResponseTime,
          api_status_code: 200, // Assuming success means 200
          checkin_payload_size: payloadSize
        });
        
        // Remove checked-in appointment from valid set and reset form
        validAppointmentIds.delete(appt.AppointmentId);
        criteriaInput.value = '';
        findBtn.disabled = true;
        resetForm();
        status(`Check-in complete – ${validAppointmentIds.size} scheduled appointments remaining`, 'success');
        
        // Refresh the valid appointments list in background
        const refreshOrg = orgInput.value.trim();
        api('scheduled', { org: refreshOrg, token }).then(r => {
          if (r.success && r.appointments) {
            validAppointmentIds = new Set(r.appointments.map(a => String(a.AppointmentId)).filter(Boolean));
          }
        });
      } else {
        // Track check-in failure with appointment-specific metadata
        trackEvent('checkin_failed', {
          org: org,
          appointment_id: appt.AppointmentId || 'unknown',
          carrier_id: appt.CarrierId || null,
          trailer_id: appt.TrailerId || null,
          equipment_type_id: appt.EquipmentTypeId || null,
          appointment_type_id: appt.AppointmentTypeId || null,
          bol: bol,
          error: res.error || 'Check-in failed',
          error_message: res.error || 'Check-in failed',
          checkin_duration_ms: checkinDuration,
          api_response_time_ms: apiResponseTime,
          api_success: false
        });
        
        // USER-FRIENDLY ERROR
        status('Check In Failed. Please see Receiving Office.', 'error');
        validateCheckIn();
      }
    }
    // ===== SIGNATURE ENHANCEMENT & UPLOAD =====

    // Enhance signature image with Manhattan logo watermark + metadata
    function enhanceSignatureImage(appointmentId, objectLabel) {
      return new Promise((resolve) => {
        const logo = new Image();
        logo.crossOrigin = 'anonymous';
        logo.onload = () => buildEnhancedImage(logo);
        logo.onerror = () => buildEnhancedImage(null); // Fallback without logo
        logo.src = '/manhattan-logo.png';

        function buildEnhancedImage(logoImg) {
          const ratio = window.devicePixelRatio || 1;
          const origW = sigCanvas.width / ratio;
          const origH = sigCanvas.height / ratio;

          const padding = 10;
          const lineHeight = 18;
          const textLines = [
            `Appointment: ${appointmentId}`,
            objectLabel,
            `Signed by: ${fld.driverName.value.trim() || 'Unknown'}`,
            new Date().toLocaleString('en-US')
          ];

          // Calculate logo dimensions
          let logoW = 0, logoH = 0, textSpacing = 0;
          if (logoImg) {
            logoW = 120;
            logoH = (logoImg.height / logoImg.width) * logoW;
            textSpacing = 10;
          }

          const headerHeight = padding + logoH + textSpacing + (textLines.length * lineHeight) + padding;

          const enhCanvas = document.createElement('canvas');
          enhCanvas.width = origW;
          enhCanvas.height = origH + headerHeight;
          const ctx = enhCanvas.getContext('2d');

          // White background
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, enhCanvas.width, enhCanvas.height);

          // Draw logo
          if (logoImg) {
            ctx.drawImage(logoImg, padding, padding, logoW, logoH);
          }

          // Header text below logo
          ctx.fillStyle = '#000000';
          ctx.font = '12px Arial';
          const textStartY = padding + logoH + textSpacing;
          textLines.forEach((line, i) => {
            ctx.fillText(line, padding, textStartY + (i + 1) * lineHeight);
          });

          // Draw original signature below header
          ctx.drawImage(sigCanvas, 0, 0, sigCanvas.width, sigCanvas.height,
                         0, headerHeight, origW, origH);

          const dataURL = enhCanvas.toDataURL('image/png');
          const base64Data = dataURL.replace(/^data:image\/png;base64,/, '');
          resolve({ dataURL, base64Data });
        }
      });
    }

    // Upload signature for all ASNs and POs from AppointmentContents
    async function uploadSignaturesForAppointment(appt, org) {
      const contents = appt.AppointmentContents;
      if (!contents || !Array.isArray(contents) || contents.length === 0) {
        console.log('[SIGNATURE] No AppointmentContents to upload against');
        return;
      }

      const appointmentId = appt.AppointmentId || 'Unknown';
      const driverName = fld.driverName.value.trim() || 'Unknown';
      const timestamp = new Date().toLocaleString('en-US');
      const notes = `${timestamp}, ${driverName}`;

      // Collect unique ASNs and POs
      const uploads = [];
      const seenIds = new Set();

      contents.forEach(item => {
        const asnObj = item.AsnId;
        if (asnObj) {
          const asnId = typeof asnObj === 'string' ? asnObj : (asnObj.AsnId || null);
          if (asnId && !seenIds.has('ASN:' + asnId)) {
            seenIds.add('ASN:' + asnId);
            uploads.push({ objectTypeId: 'ASN', objectId: asnId, label: `ASN: ${asnId}` });
          }
        }
        const poObj = item.PurchaseOrderId;
        if (poObj) {
          const poId = typeof poObj === 'string' ? poObj : (poObj.PurchaseOrderId || null);
          if (poId && !seenIds.has('PO:' + poId)) {
            seenIds.add('PO:' + poId);
            uploads.push({ objectTypeId: 'PurchaseOrder', objectId: poId, label: `PO: ${poId}` });
          }
        }
      });

      if (uploads.length === 0) {
        console.log('[SIGNATURE] No ASNs or POs found in AppointmentContents');
        return;
      }

      console.log(`[SIGNATURE] Uploading signature for ${uploads.length} object(s)`);

      for (const upload of uploads) {
        try {
          // Enhance signature with watermark specific to this object
          const { base64Data } = await enhanceSignatureImage(appointmentId, upload.label);
          const filename = `Signature_${appointmentId}_${upload.objectId}.png`;

          const res = await api('upload_signature', {
            org,
            token,
            objectTypeId: upload.objectTypeId,
            objectId: upload.objectId,
            filename,
            fileData: base64Data,
            notes
          });

          if (res.success) {
            console.log(`[SIGNATURE] Uploaded for ${upload.objectTypeId}: ${upload.objectId}`);
          } else {
            console.warn(`[SIGNATURE] Failed for ${upload.objectTypeId}: ${upload.objectId}:`, res.error);
          }
        } catch (err) {
          console.warn(`[SIGNATURE] Error uploading for ${upload.objectTypeId}: ${upload.objectId}:`, err);
        }
      }
    }

    // ===== SIGNATURE PAD =====
    const sigCanvas = document.getElementById('signaturePad');
    const sigCtx = sigCanvas.getContext('2d');
    let sigDrawing = false;

    function resizeSignatureCanvas() {
      const wrapper = sigCanvas.parentElement;
      const w = wrapper.offsetWidth;
      if (w === 0) return; // Skip if form is hidden
      const ratio = window.devicePixelRatio || 1;
      const h = 240;
      sigCanvas.width = w * ratio;
      sigCanvas.height = h * ratio;
      sigCanvas.style.height = h + 'px';
      sigCtx.scale(ratio, ratio);
      setupSigStyle();
    }

    function setupSigStyle() {
      const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#e0e0e0';
      sigCtx.strokeStyle = textColor;
      sigCtx.lineWidth = 2;
      sigCtx.lineCap = 'round';
      sigCtx.lineJoin = 'round';
    }

    function getSigPos(e) {
      const rect = sigCanvas.getBoundingClientRect();
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }

    function sigStart(e) {
      sigDrawing = true;
      const pos = getSigPos(e);
      sigCtx.beginPath();
      sigCtx.moveTo(pos.x, pos.y);
    }
    function sigMove(e) {
      if (!sigDrawing) return;
      const pos = getSigPos(e);
      sigCtx.lineTo(pos.x, pos.y);
      sigCtx.stroke();
      if (!hasSigned) {
        hasSigned = true;
        validateCheckIn();
      }
    }
    function sigStop() { sigDrawing = false; }

    sigCanvas.addEventListener('mousedown', sigStart);
    sigCanvas.addEventListener('mousemove', sigMove);
    sigCanvas.addEventListener('mouseup', sigStop);
    sigCanvas.addEventListener('mouseleave', sigStop);
    sigCanvas.addEventListener('touchstart', e => { e.preventDefault(); sigStart(e.touches[0]); }, { passive: false });
    sigCanvas.addEventListener('touchmove', e => { e.preventDefault(); sigMove(e.touches[0]); }, { passive: false });
    sigCanvas.addEventListener('touchend', sigStop);

    function clearSignaturePad() {
      const ratio = window.devicePixelRatio || 1;
      sigCtx.clearRect(0, 0, sigCanvas.width / ratio, sigCanvas.height / ratio);
    }

    document.getElementById('clearSignature').onclick = () => {
      clearSignaturePad();
      hasSigned = false;
      validateCheckIn();
    };

    // Initialize canvas size
    resizeSignatureCanvas();
    window.addEventListener('resize', resizeSignatureCanvas);

  </script>
  <!-- Vercel Analytics -->
  <script>
    (function() {
      const script = document.createElement('script');
      script.src = '/_vercel/insights/script.js';
      script.defer = true;
      script.onerror = function() {
        console.warn('Vercel Analytics script failed to load. Make sure Analytics is enabled in Vercel dashboard and the app is redeployed.');
      };
      document.head.appendChild(script);
    })();
  </script>
</body>
</html>